services:
  init:
    build: .
    container_name: outbox-init
    command: ["sh", "-c", "outbox-admin init-db && outbox-admin config import /etc/outbox/outbox.ini"]
    volumes:
      - ./instance:/data
      - ${GATEKEEPER_INSTANCE:-../gatekeeper/instance}:/gatekeeper-data:ro
      - ./config.ini:/etc/outbox/outbox.ini:ro
    environment:
      - OUTBOX_DB=/data/outbox.sqlite3
      - TZ=${TZ:-UTC}
    restart: "no"
    profiles:
      - init

  web:
    build: .
    container_name: outbox-web
    command: ["outbox-web"]
    volumes:
      - ./instance:/data
      - ${GATEKEEPER_INSTANCE:-../gatekeeper/instance}:/gatekeeper-data:ro
    environment:
      - OUTBOX_DB=/data/outbox.sqlite3
      - TZ=${TZ:-UTC}
    networks:
      - platform-net
    restart: unless-stopped

  worker:
    build: .
    container_name: outbox-worker
    command: ["python", "-m", "worker.queue_worker"]
    volumes:
      - ./instance:/data
      - ${GATEKEEPER_INSTANCE:-../gatekeeper/instance}:/gatekeeper-data:ro
    environment:
      - OUTBOX_DB=/data/outbox.sqlite3
      - SMTP_HOST=${SMTP_HOST:-}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - SMTP_FROM=${SMTP_FROM:-}
      - TZ=${TZ:-UTC}
    networks:
      - platform-net
    restart: unless-stopped

networks:
  platform-net:
    external: true
